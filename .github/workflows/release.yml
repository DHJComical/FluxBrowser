name: Release FluxBrowser

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: windows-latest

    permissions:
      contents: write # å¿…é¡»èµ‹äºˆå†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³•åˆ›å»º Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          # 1. å®‰å…¨åœ°è·å–æäº¤èŒƒå›´
          $currentTag = "${{ github.ref_name }}"
          # ä½¿ç”¨å¼•å·åŒ…è£¹å˜é‡å’Œ ^ï¼Œé˜²æ­¢ PowerShell è§£æé”™è¯¯
          $prevTag = git describe --tags --abbrev=0 "$currentTag^" 2>$null
          
          # 2. æ ¹æ®æ˜¯å¦æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾å†³å®š log èŒƒå›´
          if ($prevTag) {
              $range = "$prevTag..$currentTag"
              $commits = git log $range --pretty=format:"%s"
          } else {
              $commits = git log --pretty=format:"%s"
          }

          # 3. å®šä¹‰æå–å‡½æ•° (å¢åŠ å¯¹ç©ºæäº¤è®°å½•çš„é˜²å¾¡)
          function Get-Group($prefix, $title) {
              if (-not $commits) { return "" }
              $pattern = "^$prefix[:\(]"
              $matched = $commits | Where-Object { $_ -match $pattern }
              if ($matched) {
                  $lines = $matched | ForEach-Object { "* $_" }
                  return "### $title`n$($lines -join "`n")`n`n"
              }
              return ""
          }

          # 4. æ‹¼è£…å†…å®¹
          $body = "## ğŸ“ æ›´æ–°æ—¥å¿— ($currentTag)`n`n"
          $body += Get-Group "feat" "ğŸš€ æ–°ç‰¹æ€§"
          $body += Get-Group "improve" "âš¡ æ”¹è¿›"
          $body += Get-Group "fix" "ğŸ› ä¿®å¤"
          $body += Get-Group "refactor" "ğŸ› ï¸ é‡æ„"
          $body += Get-Group "chore" "ğŸ§¹ çäº‹"
          $body += Get-Group "version" "ğŸ”– ç‰ˆæœ¬æ›´æ–°"

          # 5. å…œåº•ï¼šæŠ“å–ä¸ç¬¦åˆè§„èŒƒçš„æäº¤
          if ($commits) {
              $others = $commits | Where-Object { 
                  $_ -notmatch "^(feat|fix|improve|chore|refactor|version)[:\(]" 
              }
              if ($others) {
                  $otherLines = $others | ForEach-Object { "* $_" }
                  $body += "### ğŸ” å…¶ä»–æ”¹åŠ¨`n$($otherLines -join "`n")"
              }
          }

          # 6. å†™å…¥æ–‡ä»¶ (å¼ºåˆ¶ UTF-8 æ—  BOM)
          $path = "$PWD/release_notes.md"
          [System.IO.File]::WriteAllText($path, $body, [System.Text.Encoding]::UTF8)

          # 7. åˆ›å»º Release
          gh release create $currentTag --title "Release $currentTag" --notes-file $path --latest

      - name: Build and Publish Electron App
        run: npm run build -- --publish always
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}